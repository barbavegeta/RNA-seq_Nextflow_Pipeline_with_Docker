name: rnaseq-nf test

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (for Nextflow)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/
          nextflow -version

      # Cache Nextflow assets + plugins between runs
      - name: Cache Nextflow
        uses: actions/cache@v4
        with:
          path: |
            ~/.nextflow
          key: ${{ runner.os }}-nextflow-${{ hashFiles('nextflow.config', 'main.nf', 'Dockerfile', 'containers/**', 'bin/**', 'tests/**') }}

      # Docker buildx (better caching + consistent builds)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Cache Docker build layers to speed up subsequent CI runs
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('containers/**/Dockerfile', 'containers/**/environment.yml', 'containers/**', 'bin/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build pipeline images
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new \
            -t rnaseq-tools:0.1.0 \
            containers/rnaseq-tools

          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new \
            -t rnaseq-r:0.1.0 \
            containers/rnaseq-r

          # Move updated cache into place
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Run test pipeline (docker)
        env:
          NXF_ANSI_LOG: false
        run: |
          nextflow run main.nf \
            -profile docker \
            --samplesheet tests/samplesheet.test.csv \
            --genome_fasta tests/ref/genome.fasta \
            --genome_gtf tests/ref/genes.gtf \
            --design tests/design.test.tsv \
            --outdir results_test \
            -with-report report.html \
            -with-trace trace.txt \
            -with-timeline timeline.html

      - name: Upload outputs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-and-reports
          path: |
            results_test
            report.html
            trace.txt
            timeline.html
            .nextflow.log